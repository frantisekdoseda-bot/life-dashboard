<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Life Dashboard</title>

<style>
body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,system-ui;
background:#0b1220;
color:white;
}

.wrap{
padding:20px;
max-width:520px;
margin:auto;
}

.card{
background:linear-gradient(180deg,#0f1b35,#0b1220);
padding:22px;
border-radius:26px;
margin-bottom:18px;
box-shadow:0 10px 30px rgba(0,0,0,.35);
}

.big{
font-size:32px;
font-weight:700;
}

.row{
opacity:.9;
margin-top:6px;
}

.small{
opacity:.6;
font-size:12px;
margin-top:6px;
}

.stopname{
color:#7dd3fc;
font-weight:700;
font-size:18px;
margin:16px 0 6px 0;
}

.line{
font-size:14px;
margin:3px 0;
}
</style>
</head>

<body>
<div class="wrap">

<div class="card">
<div class="big" id="city">Naƒç√≠t√°m‚Ä¶</div>
<div class="big" id="temp"></div>
<div class="row" id="meta"></div>
<div class="row" id="sun"></div>
<div class="small" id="forecast"></div>
</div>

<div class="card">
<div class="stopname">üöã Veletr≈æn√≠ pal√°c</div>
<div id="v">Naƒç√≠t√°m‚Ä¶</div>

<div class="stopname">üöã Strossmayerovo n√°m.</div>
<div id="s">Naƒç√≠t√°m‚Ä¶</div>
</div>

</div>

<script>
const GOLEMIO="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6NDg0MCwiaWF0IjoxNzcxODA0NzA1LCJleHAiOjExNzcxODA0NzA1LCJpc3MiOiJnb2xlbWlvIiwianRpIjoiZDQzZDVlMDktNmVhZS00ZGQwLWEzMTAtMjI5YjZmZTQ4NmE0In0.5Wgnlm02CytmAfA-N6_-kXCyRhidvhcaQ7-XaO9GGsw";

// ===== MƒöS√çC =====
function moonPhase(){
const now=new Date();
const synodic=29.53058867;
const known=new Date(Date.UTC(2000,0,6,18,14,0));
const days=(now-known)/86400000;
let phase=(days%synodic)/synodic;
if(phase<0) phase+=1;

if(phase<0.03||phase>0.97) return "üåë Nov";
if(phase<0.22) return "üåí Dor≈Østaj√≠c√≠ srpek";
if(phase<0.28) return "üåì Prvn√≠ ƒçtvr≈•";
if(phase<0.47) return "üåî Dor≈Østaj√≠c√≠ mƒõs√≠c";
if(phase<0.53) return "üåï √öplnƒõk";
if(phase<0.72) return "üåñ Ub√Ωvaj√≠c√≠ mƒõs√≠c";
if(phase<0.78) return "üåó Posledn√≠ ƒçtvr≈•";
return "üåò Ub√Ωvaj√≠c√≠ srpek";
}

// ===== POƒåAS√ç =====
async function loadWeather(lat,lon){

let r=await fetch(
`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,precipitation,apparent_temperature,uv_index&daily=sunrise,sunset&timezone=Europe%2FPrague`
);

let j=await r.json();

document.getElementById("temp").innerHTML=
`${j.current_weather.temperature}¬∞ <span style="opacity:.6;font-size:20px">(${Math.round(j.current_weather.temperature)}¬∞)</span>`;

document.getElementById("meta").innerHTML=
`üåß ${j.hourly.precipitation[0]}mm &nbsp; üí® ${j.current_weather.windspeed}km/h &nbsp; UV ${j.hourly.uv_index[0]}`;

let sunrise=j.daily.sunrise[0].substring(11,16);
let sunset=j.daily.sunset[0].substring(11,16);

document.getElementById("sun").innerHTML=
`‚òÄÔ∏è ${sunrise} &nbsp; üåá ${sunset} &nbsp; ${moonPhase()}`;

// forecast od aktu√°ln√≠ hodiny
let nowHour=new Date().getHours();
let forecast="";
let count=0;

for(let i=0;i<j.hourly.time.length;i++){
let hour=parseInt(j.hourly.time[i].substring(11,13));
if(hour>=nowHour && count<5){
let h=j.hourly.time[i].substring(11,16);
let t=j.hourly.temperature_2m[i];
let r=j.hourly.precipitation[i];
forecast+=`${h} ${t}¬∞ ${r}mm &nbsp; `;
count++;
}
}

document.getElementById("forecast").innerHTML=forecast;
}

// ===== PID =====
async function stop(id,el){
try{
let r=await fetch(`https://api.golemio.cz/v2/pid/departureboards?ids=${id}&limit=12`,{
headers:{"x-access-token":GOLEMIO}
});
let j=await r.json();

if(!j.departures||j.departures.length==0){
document.getElementById(el).innerHTML="≈æ√°dn√© spoje";
return;
}

let html="";

j.departures.slice(0,8).forEach(d=>{

let line=d.route.short_name;
let finalDir=d.trip.headsign;
let ts=d.departure_timestamp.predicted||d.departure_timestamp.scheduled;
let dep=new Date(ts);
let mins=Math.round((dep-new Date())/60000);
if(mins<0) mins=0;

let delayMin=0;
if(d.delay && d.delay.actual){
delayMin=Math.round(d.delay.actual/60);
}

let next=d.next_stop?.stop_name || "";
let lineColor = delayMin>3 ? "#ff4d4f" : "#ffffff";
let time=dep.toLocaleTimeString("cs-CZ",{hour:"2-digit",minute:"2-digit"});

html+=`
<div class="line">
<span style="color:${lineColor};font-weight:600">${line}</span>
 ‚Ä¢ ${next} (${mins}m) ${time} ‚Üí ${finalDir}
</div>
`;

});

document.getElementById(el).innerHTML=html;

}catch(e){
document.getElementById(el).innerHTML="PID chyba";
}
}

// ===== INIT =====
async function run(){

navigator.geolocation.getCurrentPosition(async pos=>{

let lat=pos.coords.latitude;
let lon=pos.coords.longitude;

let geo=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
let g=await geo.json();
document.getElementById("city").innerHTML=
g.address.city||g.address.town||g.address.village||"Moje poloha";

loadWeather(lat,lon);

});

stop("U303Z1P","v");
stop("U325Z1P","s");
}

run();
setInterval(run,60000);
</script>

</body>
</html>
