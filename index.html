<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Life Dashboard</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,system-ui;
  background:#0b1220;
  color:white;
}
.wrap{padding:18px;max-width:520px;margin:auto;}
.card{
  background:linear-gradient(180deg,#0f1b35,#0b1220);
  padding:20px;border-radius:24px;margin-bottom:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.big{font-size:30px;font-weight:700;}
.row{opacity:.9;margin-top:6px;}
.small{opacity:.65;font-size:12px;margin-top:6px;}
.stopname{color:#7dd3fc;font-weight:700;font-size:17px;margin:14px 0 6px 0;}
.line{font-size:14px;margin:3px 0;}
</style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <div class="big" id="city">NaÄÃ­tÃ¡mâ€¦</div>
    <div class="big" id="temp"></div>
    <div class="row" id="meta"></div>
    <div class="row" id="sun"></div>
    <div class="row" id="air"></div>
    <div class="small" id="forecast"></div>
  </div>

  <div class="card">
    <div class="stopname">ğŸš‹ VeletrÅ¾nÃ­ palÃ¡c</div>
    <div id="v">NaÄÃ­tÃ¡mâ€¦</div>

    <div class="stopname">ğŸš‹ Strossmayerovo nÃ¡m.</div>
    <div id="s">NaÄÃ­tÃ¡mâ€¦</div>

    <div class="stopname">ğŸš‹ VÃ¡clavskÃ© nÃ¡m.</div>
    <div id="m">NaÄÃ­tÃ¡mâ€¦</div>
  </div>

</div>

<script>
const GOLEMIO = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6NDg0MCwiaWF0IjoxNzcxODA0NzA1LCJleHAiOjExNzcxODA0NzA1LCJpc3MiOiJnb2xlbWlvIiwianRpIjoiZDQzZDVlMDktNmVhZS00ZGQwLWEzMTAtMjI5YjZmZTQ4NmE0In0.5Wgnlm02CytmAfA-N6_-kXCyRhidvhcaQ7-XaO9GGsw";

let cachedLat = null;
let cachedLon = null;

// Cache nalezenÃ½ch stop IDs (aby se nemusely hledat pokaÅ¾dÃ©)
let stopIdCache = {};

function weatherEmoji(code) {
  if (code === 0)                return "â˜€ï¸";
  if (code === 1)                return "ğŸŒ¤ï¸";
  if (code === 2)                return "â›…";
  if (code === 3)                return "â˜ï¸";
  if (code >= 45 && code <= 48)  return "ğŸŒ«ï¸";
  if (code >= 51 && code <= 55)  return "ğŸŒ¦ï¸";
  if (code >= 56 && code <= 57)  return "ğŸŒ¨ï¸";
  if (code >= 61 && code <= 65)  return "ğŸŒ§ï¸";
  if (code >= 66 && code <= 67)  return "ğŸŒ¨ï¸";
  if (code >= 71 && code <= 77)  return "ğŸŒ¨ï¸";
  if (code >= 80 && code <= 82)  return "ğŸŒ§ï¸";
  if (code >= 85 && code <= 86)  return "ğŸŒ¨ï¸";
  if (code >= 95 && code <= 99)  return "ğŸŒ©ï¸";
  return "ğŸŒ¤ï¸";
}

function aqiLabel(aqi) {
  if (aqi <= 20)  return "ğŸŸ¢ VÃ½bornÃ½";
  if (aqi <= 40)  return "ğŸŸ¡ DobrÃ½";
  if (aqi <= 60)  return "ğŸŸ  StÅ™ednÃ­";
  if (aqi <= 80)  return "ğŸ”´ Å patnÃ½";
  if (aqi <= 100) return "ğŸŸ£ Velmi Å¡patnÃ½";
  return "âš« NebezpeÄnÃ½";
}

function moonPhase() {
  const now = new Date();
  const jd = now.getTime() / 86400000 + 2440587.5;
  const knownNewMoon = 2451550.1;
  const synodic = 29.530588853;
  let age = (jd - knownNewMoon) % synodic;
  if (age < 0) age += synodic;
  const q = synodic / 4;
  const w = 0.5;
  if (age < w || age > synodic - w)  return "ğŸŒ‘ Nov";
  if (Math.abs(age - q) < w)        return "ğŸŒ“ PrvnÃ­ ÄtvrÅ¥";
  if (Math.abs(age - 2 * q) < w)    return "ğŸŒ• ÃšplnÄ›k";
  if (Math.abs(age - 3 * q) < w)    return "ğŸŒ— PoslednÃ­ ÄtvrÅ¥";
  if (age < q)     return "ğŸŒ’ DorÅ¯stajÃ­cÃ­ srpek";
  if (age < 2 * q) return "ğŸŒ” DorÅ¯stajÃ­cÃ­ mÄ›sÃ­c";
  if (age < 3 * q) return "ğŸŒ– UbÃ½vajÃ­cÃ­ mÄ›sÃ­c";
  return "ğŸŒ˜ UbÃ½vajÃ­cÃ­ srpek";
}

async function loadWeather(lat, lon) {
  try {
    let r = await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,precipitation,apparent_temperature,uv_index,windspeed_10m,weathercode&daily=sunrise,sunset,uv_index_max&timezone=Europe%2FPrague`
    );
    let j = await r.json();
    let now = new Date();
    let index = j.hourly.time.findIndex(t => new Date(t) >= now);
    if (index < 0) index = j.hourly.time.length - 1;

    let temp = Math.round(j.current_weather.temperature);
    let feel = Math.round(j.hourly.apparent_temperature[index]);
    let wCode = j.current_weather.weathercode;

    document.getElementById("temp").innerHTML =
      `${weatherEmoji(wCode)} ${temp}Â° <span style="opacity:.6;font-size:20px">(${feel}Â°)</span>`;

    let uvHourly = j.hourly.uv_index[index] || 0;
    let uvMax    = j.daily.uv_index_max[0] || 0;
    let uvVal    = Math.round(uvHourly > 0 ? uvHourly : uvMax);

    document.getElementById("meta").innerHTML =
      `ğŸŒ§ï¸ ${Math.round(j.hourly.precipitation[index])}mm &nbsp; ğŸŒªï¸ ${Math.round(j.hourly.windspeed_10m[index])}km/h &nbsp; UV ${uvVal}`;

    let sunrise = j.daily.sunrise[0].substring(11, 16);
    let sunset  = j.daily.sunset[0].substring(11, 16);

    document.getElementById("sun").innerHTML =
      `â˜€ï¸ ${sunrise} &nbsp; ğŸŒ™ ${sunset} &nbsp; ${moonPhase()}`;

    let forecast = "";
    for (let i = 0; i < 5; i++) {
      let idx = index + i;
      if (!j.hourly.time[idx]) break;
      let h      = j.hourly.time[idx].substring(11, 16);
      let t      = Math.round(j.hourly.temperature_2m[idx]);
      let precip = Math.round(j.hourly.precipitation[idx]);
      let hCode  = j.hourly.weathercode[idx];
      forecast += `${h} ${weatherEmoji(hCode)} ${t}Â° ${precip}mm &nbsp; `;
    }
    document.getElementById("forecast").innerHTML = forecast;
  } catch (e) {
    document.getElementById("temp").innerHTML = "Chyba poÄasÃ­";
  }
}

async function loadAirQuality(lat, lon) {
  try {
    let r = await fetch(
      `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=european_aqi,pm10,pm2_5&timezone=Europe%2FPrague`
    );
    let j = await r.json();
    let now = new Date();
    let index = j.hourly.time.findIndex(t => new Date(t) >= now);
    if (index < 0) index = j.hourly.time.length - 1;
    let aqi  = Math.round(j.hourly.european_aqi[index] || 0);
    let pm25 = Math.round(j.hourly.pm2_5[index] || 0);
    let pm10 = Math.round(j.hourly.pm10[index] || 0);
    document.getElementById("air").innerHTML =
      `ğŸŒ¬ï¸ ${aqiLabel(aqi)} (AQI ${aqi}) &nbsp; PM2.5: ${pm25} &nbsp; PM10: ${pm10}`;
  } catch (e) {}
}

// ===== PID: Najdi stop IDs podle jmÃ©na pÅ™es GTFS stops API =====
async function findStopIds(stopName) {
  if (stopIdCache[stopName]) return stopIdCache[stopName];
  try {
    let r = await fetch(
      `https://api.golemio.cz/v2/gtfs/stops?names[]=${encodeURIComponent(stopName)}`,
      { headers: { "x-access-token": GOLEMIO } }
    );
    let j = await r.json();
    let ids = [];
    if (j.features) {
      j.features.forEach(f => {
        if (f.properties && f.properties.stop_id) {
          ids.push(f.properties.stop_id);
        }
      });
    } else if (Array.isArray(j)) {
      j.forEach(s => {
        if (s.stop_id) ids.push(s.stop_id);
      });
    }
    stopIdCache[stopName] = ids;
    return ids;
  } catch (e) {
    return [];
  }
}

// ===== PID: Odjezdy podle nÃ¡zvu zastÃ¡vky =====
async function loadStop(stopName, el) {
  try {
    // ZkusÃ­me pÅ™Ã­mo names[] parametr v departureboard API
    let r = await fetch(
      `https://api.golemio.cz/v2/pid/departureboards?names[]=${encodeURIComponent(stopName)}&limit=15`,
      { headers: { "x-access-token": GOLEMIO } }
    );
    let j = await r.json();

    // Pokud names[] nefunguje, fallback na nalezenÃ¡ IDs
    if (!j.departures || j.departures.length === 0) {
      let ids = await findStopIds(stopName);
      if (ids.length === 0) {
        document.getElementById(el).innerHTML = "ZastÃ¡vka nenalezena";
        return;
      }
      // Volej pro kaÅ¾dÃ© ID
      let allDepartures = [];
      for (let id of ids) {
        try {
          let r2 = await fetch(
            `https://api.golemio.cz/v2/pid/departureboards?ids=${id}&limit=10`,
            { headers: { "x-access-token": GOLEMIO } }
          );
          let j2 = await r2.json();
          if (j2.departures) allDepartures = allDepartures.concat(j2.departures);
        } catch (e) {}
      }
      j = { departures: allDepartures };
    }

    if (!j.departures || j.departures.length === 0) {
      document.getElementById(el).innerHTML = "Å¾Ã¡dnÃ© spoje";
      return;
    }

    // SeÅ™aÄ podle Äasu
    j.departures.sort((a, b) => {
      let ta = new Date(a.departure_timestamp.predicted || a.departure_timestamp.scheduled);
      let tb = new Date(b.departure_timestamp.predicted || b.departure_timestamp.scheduled);
      return ta - tb;
    });

    let html = "";
    j.departures.slice(0, 8).forEach(d => {
      let line     = d.route.short_name;
      let finalDir = d.trip.headsign;

      let predictedTs = d.departure_timestamp.predicted || d.departure_timestamp.scheduled;
      let dep = new Date(predictedTs);
      let totalMins = Math.round((dep - new Date()) / 60000);
      if (totalMins < 0) totalMins = 0;

      let delayMin = 0;
      if (d.delay && d.delay.seconds != null) {
        delayMin = Math.round(d.delay.seconds / 60);
      }

      let lineColor = delayMin > 2 ? "#ff4d4f" : "#ffffff";
      let time = dep.toLocaleTimeString("cs-CZ", { hour: "2-digit", minute: "2-digit" });

      let delayTag = delayMin > 0
        ? `<span style="color:#ff4d4f">+${delayMin}</span>`
        : "";

      // PoslednÃ­ projetÃ¡ zastÃ¡vka
      let lastStop = "";
      if (d.last_stop && d.last_stop.name) {
        lastStop = d.last_stop.name + " ";
      }

      html += `
        <div class="line">
          <span style="color:${lineColor};font-weight:600">${line}</span>
          â€¢ ${lastStop}(${totalMins}m${delayTag}) ${time} â†’ ${finalDir}
        </div>`;
    });

    document.getElementById(el).innerHTML = html;
  } catch (e) {
    document.getElementById(el).innerHTML = "PID chyba";
  }
}

function refresh() {
  if (cachedLat !== null) {
    loadWeather(cachedLat, cachedLon);
    loadAirQuality(cachedLat, cachedLon);
  }
  loadStop("VeletrÅ¾nÃ­ palÃ¡c", "v");
  loadStop("Strossmayerovo nÃ¡mÄ›stÃ­", "s");
  loadStop("VÃ¡clavskÃ© nÃ¡mÄ›stÃ­", "m");
}

function init() {
  navigator.geolocation.getCurrentPosition(
    async pos => {
      cachedLat = pos.coords.latitude;
      cachedLon = pos.coords.longitude;
      try {
        let geo = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${cachedLat}&lon=${cachedLon}`
        );
        let g = await geo.json();
        document.getElementById("city").innerHTML =
          g.address.city || g.address.town || g.address.village || "Moje poloha";
      } catch (e) {
        document.getElementById("city").innerHTML = "Moje poloha";
      }
      loadWeather(cachedLat, cachedLon);
      loadAirQuality(cachedLat, cachedLon);
    },
    () => {
      cachedLat = 50.0755;
      cachedLon = 14.4378;
      document.getElementById("city").innerHTML = "Praha (fallback)";
      loadWeather(cachedLat, cachedLon);
      loadAirQuality(cachedLat, cachedLon);
    }
  );

  loadStop("VeletrÅ¾nÃ­ palÃ¡c", "v");
  loadStop("Strossmayerovo nÃ¡mÄ›stÃ­", "s");
  loadStop("VÃ¡clavskÃ© nÃ¡mÄ›stÃ­", "m");
}

init();
setInterval(refresh, 60000);
</script>

</body>
</html>
