<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Life Dashboard</title>

<style>
body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,system-ui;
background:#0b1220;
color:white;
}
.wrap{padding:18px;max-width:520px;margin:auto;}
.card{
background:linear-gradient(180deg,#0f1b35,#0b1220);
padding:20px;border-radius:24px;margin-bottom:16px;
box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.big{font-size:30px;font-weight:700;}
.row{opacity:.9;margin-top:6px;}
.small{opacity:.65;font-size:12px;margin-top:6px;}
.stopname{color:#7dd3fc;font-weight:700;font-size:17px;margin:14px 0 6px 0;}
.line{font-size:14px;margin:3px 0;}
</style>
</head>

<body>
<div class="wrap">

<div class="card">
<div class="big" id="city">NaÄÃ­tÃ¡mâ€¦</div>
<div class="big" id="temp"></div>
<div class="row" id="meta"></div>
<div class="row" id="sun"></div>
<div class="small" id="forecast"></div>
</div>

<div class="card">
<div class="stopname">ğŸš‹ VeletrÅ¾nÃ­ palÃ¡c</div>
<div id="v">NaÄÃ­tÃ¡mâ€¦</div>

<div class="stopname">ğŸš‹ Strossmayerovo nÃ¡m.</div>
<div id="s">NaÄÃ­tÃ¡mâ€¦</div>

<div class="stopname">ğŸš‹ VÃ¡clavskÃ© nÃ¡m. (MÅ¯stek)</div>
<div id="m">NaÄÃ­tÃ¡mâ€¦</div>
</div>

</div>

<script>
const GOLEMIO="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6NDg0MCwiaWF0IjoxNzcxODA0NzA1LCJleHAiOjExNzcxODA0NzA1LCJpc3MiOiJnb2xlbWlvIiwianRpIjoiZDQzZDVlMDktNmVhZS00ZGQwLWEzMTAtMjI5YjZmZTQ4NmE0In0.5Wgnlm02CytmAfA-N6_-kXCyRhidvhcaQ7-XaO9GGsw";

// ===== SPRÃVNÃ MÄšSÃC =====
function moonPhase(){
const now = new Date();
const lp = 2551443;
const new_moon = new Date(1970,0,7,20,35,0);
const phase = ((now-new_moon)/1000)%lp;
const age = phase/lp;

if(age<0.03||age>0.97) return "ğŸŒ‘ Nov";
if(age<0.25) return "ğŸŒ’ DorÅ¯stajÃ­cÃ­ srpek";
if(age<0.27) return "ğŸŒ“ PrvnÃ­ ÄtvrÅ¥";
if(age<0.48) return "ğŸŒ” DorÅ¯stajÃ­cÃ­ mÄ›sÃ­c";
if(age<0.52) return "ğŸŒ• ÃšplnÄ›k";
if(age<0.73) return "ğŸŒ– UbÃ½vajÃ­cÃ­ mÄ›sÃ­c";
if(age<0.77) return "ğŸŒ— PoslednÃ­ ÄtvrÅ¥";
return "ğŸŒ˜ UbÃ½vajÃ­cÃ­ srpek";
}

// ===== POÄŒASÃ =====
async function loadWeather(lat,lon){

let r=await fetch(
`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,precipitation,apparent_temperature,uv_index,windspeed_10m&daily=sunrise,sunset&timezone=Europe%2FPrague`
);
let j=await r.json();

// aktuÃ¡lnÃ­ index hodiny
let now=new Date();
let index=j.hourly.time.findIndex(t=> new Date(t) > now);
if(index<0) index=0;

let temp=Math.round(j.current_weather.temperature);
let feel=Math.round(j.hourly.apparent_temperature[index]);

document.getElementById("temp").innerHTML=
`${temp}Â° <span style="opacity:.6;font-size:20px">(${feel}Â°)</span>`;

document.getElementById("meta").innerHTML=
`ğŸŒ§ ${Math.round(j.hourly.precipitation[index])}mm &nbsp; ğŸ’¨ ${Math.round(j.hourly.windspeed_10m[index])}km/h &nbsp; UV ${Math.round(j.hourly.uv_index[index])}`;

let sunrise=j.daily.sunrise[0].substring(11,16);
let sunset=j.daily.sunset[0].substring(11,16);

document.getElementById("sun").innerHTML=
`â˜€ï¸ ${sunrise} &nbsp; ğŸŒ‡ ${sunset} &nbsp; ${moonPhase()}`;

// forecast 5h dopÅ™edu OD BUDOUCÃ HODINY
let forecast="";
for(let i=0;i<5;i++){
let idx=index+i;
if(!j.hourly.time[idx]) break;

let h=j.hourly.time[idx].substring(11,16);
let t=Math.round(j.hourly.temperature_2m[idx]);
let r=Math.round(j.hourly.precipitation[idx]);

forecast+=`${h} ${t}Â° ${r}mm &nbsp; `;
}

document.getElementById("forecast").innerHTML=forecast;
}

// ===== PID =====
async function stop(id,el){
try{
let r=await fetch(`https://api.golemio.cz/v2/pid/departureboards?ids=${id}&limit=12`,{
headers:{"x-access-token":GOLEMIO}
});
let j=await r.json();

if(!j.departures||j.departures.length==0){
document.getElementById(el).innerHTML="Å¾Ã¡dnÃ© spoje";
return;
}

let html="";

j.departures.slice(0,8).forEach(d=>{
let line=d.route.short_name;
let finalDir=d.trip.headsign;
let ts=d.departure_timestamp.predicted||d.departure_timestamp.scheduled;
let dep=new Date(ts);
let mins=Math.round((dep-new Date())/60000);
if(mins<0) mins=0;

let delayMin=0;
if(d.delay && d.delay.actual){
delayMin=Math.round(d.delay.actual/60);
}

let next=d.next_stop?.stop_name || "";
let lineColor = delayMin>3 ? "#ff4d4f" : "#ffffff";
let time=dep.toLocaleTimeString("cs-CZ",{hour:"2-digit",minute:"2-digit"});

html+=`
<div class="line">
<span style="color:${lineColor};font-weight:600">${line}</span>
 â€¢ ${next} (${mins}m) ${time} â†’ ${finalDir}
</div>
`;
});

document.getElementById(el).innerHTML=html;

}catch(e){
document.getElementById(el).innerHTML="PID chyba";
}
}

// ===== INIT =====
async function run(){

navigator.geolocation.getCurrentPosition(async pos=>{
let lat=pos.coords.latitude;
let lon=pos.coords.longitude;

let geo=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
let g=await geo.json();
document.getElementById("city").innerHTML=
g.address.city||g.address.town||g.address.village||"Moje poloha";

loadWeather(lat,lon);
});

stop("U303Z1P","v");
stop("U325Z1P","s");
stop("U125Z1P","m");
}

run();
setInterval(run,60000);
</script>

</body>
</html>
